<!DOCTYPE html>
<html>
<body>
<style>
#drop-region {
	background-color: #fff;
	border-radius:20px;
	box-shadow:0 0 35px rgba(0,0,0,0.05);
	width:100%;
	padding:60px 40px;
	text-align: center;
	cursor:pointer;
	transition:.3s;
}
#drop-region:hover {
	box-shadow:0 0 45px rgba(0,0,0,0.1);
}

#image-preview, #mixed-preview, #unmixed-preview {
	margin-top:20px;
	display: flex;
	justify-content: center;
}
#image-preview .image-view, #mixed-preview .image-view, #unmixed-preview .image-view {
	display: inline-block;
	position:relative;
	margin-right: 13px;
	margin-bottom: 13px;
}
#image-preview .image-view img, #mixed-preview .image-view img, #unmixed-preview .image-view img {
	width: 200px;
	height: 200px;
	object-fit: cover;
}
#image-preview .overlay {
	position: absolute;
	width: 100%;
	height: 100%;
	top: 0;
	right: 0;
	z-index: 2;
	background: rgba(255,255,255,0.5);
}
</style>

<div id="drop-region">
	<div class="drop-message">
		Drag & Drop images or click to upload
	</div>
	<div id="image-preview"></div>
	<div id="mixed-preview"></div>
	<div id="unmixed-preview"></div>
</div>

<script>
var dropRegion = document.getElementById("drop-region"),
	imagePreviewRegion = document.getElementById("image-preview"),
	mixedPreviewRegion = document.getElementById("mixed-preview"),
	unmixedPreviewRegion = document.getElementById("unmixed-preview");

var fakeInput = document.createElement("input");
fakeInput.type = "file";
fakeInput.accept = "image/*";
fakeInput.multiple = true;
dropRegion.addEventListener('click', function() {
	fakeInput.click();
});

fakeInput.addEventListener("change", function() {
	var files = fakeInput.files;
	handleFiles(files);
});

function preventDefault(e) {
	e.preventDefault();
  	e.stopPropagation();
}

dropRegion.addEventListener('dragenter', preventDefault, false)
dropRegion.addEventListener('dragleave', preventDefault, false)
dropRegion.addEventListener('dragover', preventDefault, false)
dropRegion.addEventListener('drop', preventDefault, false)

function handleDrop(e) {
	var dt = e.dataTransfer,
		files = dt.files;

	if (files.length) {
		handleFiles(files);
	} else {
		var html = dt.getData('text/html'),
	        match = html && /\bsrc="?([^"\s]+)"?\s*/.exec(html),
	        url = match && match[1];

	    if (url) {
	        uploadImageFromURL(url);
	        return;
	    }
	}

	function uploadImageFromURL(url) {
		var img = new Image;
        var c = document.createElement("canvas");
        var ctx = c.getContext("2d");

        img.onload = function() {
            c.width = this.naturalWidth;
            c.height = this.naturalHeight;
            ctx.drawImage(this, 0, 0);
            c.toBlob(function(blob) {
                handleFiles( [blob] );
            }, "image/png");
        };
        img.onerror = function() {
            alert("Error in uploading");
        }
        img.crossOrigin = "";
        img.src = url;
	}

}

dropRegion.addEventListener('drop', handleDrop, false);

function handleFiles(files) {
	if(files.length == 2) {
		imagePreviewRegion.innerHTML = '';
		mixedPreviewRegion.innerHTML = '';
		unmixedPreviewRegion.innerHTML = '';
		for (var i = 0, len = files.length; i < len; i++) {
			if (validateImage(files[i]))
				previewAnduploadImage(files[i]);
		}
		if (files.length == 2) 
			showMixedImage(files[0], files[1]);
	}
}

function validateImage(image) {
	var validTypes = ['image/jpeg', 'image/png', 'image/gif'];
	if (validTypes.indexOf( image.type ) === -1) {
		alert("Invalid File Type");
		return false;
	}

	var maxSizeInBytes = 10e6;
	if (image.size > maxSizeInBytes) {
		alert("File too large");
		return false;
	}

	return true;
}

function previewAnduploadImage(image) {
	var imgView = document.createElement("div");
	imgView.className = "image-view";
	imagePreviewRegion.appendChild(imgView);

	var img = document.createElement("img");
	imgView.appendChild(img);

	var reader = new FileReader();
	reader.onload = function(e) {
		img.src = e.target.result;
	}
	reader.readAsDataURL(image);
}

function showMixedImage(file1, file2) {
	var canvas = document.createElement("canvas");
	var ctx = canvas.getContext("2d");

	var image1 = new Image();
	var image2 = new Image();

	var reader1 = new FileReader();
	var reader2 = new FileReader();

	Promise.all([
		new Promise((resolve, reject) => {
			reader1.onload = e => {
				image1.src = e.target.result;
				image1.onload = resolve;
			}
			reader1.onerror = reject;
			reader1.readAsDataURL(file1);
		}),
		new Promise((resolve, reject) => {
			reader2.onload = e => {
				image2.src = e.target.result;
				image2.onload = resolve;
			}
			reader2.onerror = reject;
			reader2.readAsDataURL(file2);
		})
	]).then(() => {
		canvas.width = image1.width;
		canvas.height = image1.height;
		ctx.drawImage(image1, 0, 0);
		var imageData1 = ctx.getImageData(0, 0, canvas.width, canvas.height);
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.drawImage(image2, 0, 0);
		var imageData2 = ctx.getImageData(0, 0, canvas.width, canvas.height);

		var mixedImageData = mixImages(imageData1, imageData2);
		ctx.putImageData(mixedImageData, 0, 0);
		var imgView = document.createElement("div");
		imgView.className = "image-view";
		mixedPreviewRegion.appendChild(imgView);
		var img = document.createElement("img");
		imgView.appendChild(img);
		img.src = canvas.toDataURL("image/png");

		var unmixedImageData = unmixImage(mixedImageData, imageData1);
		ctx.putImageData(unmixedImageData, 0, 0);
		var imgViewUnmix = document.createElement("div");
		imgViewUnmix.className = "image-view";
		unmixedPreviewRegion.appendChild(imgViewUnmix);
		var imgUnmix = document.createElement("img");
		imgViewUnmix.appendChild(imgUnmix);
		imgUnmix.src = canvas.toDataURL("image/png");
	}).catch(e => {
		console.error(e);
		alert('Error loading images');
	});
}


var fac = 4; // Set this value to control the level of mixing/unmixing

function mixImages(image1Data, image2Data) {
    var data = new Uint8ClampedArray(image1Data.data);
    for (var i = 0; i < data.length; i += 4) {
        for (var j = 0; j < 3; j++) {
            var img1Val = image1Data.data[i + j];
            var img2Val = image2Data.data[i + j];
            data[i + j] = img1Val - (img1Val % Math.pow(2, fac)) + Math.floor(img2Val / Math.pow(2, 8 - fac));
        }
        data[i + 3] = 255;
    }
    return new ImageData(data, image1Data.width, image1Data.height);
}

function unmixImage(mixedImageData) {
    var data = new Uint8ClampedArray(mixedImageData.data);
    for (var i = 0; i < data.length; i += 4) {
        for (var j = 0; j < 3; j++) {
            var imgMixedVal = mixedImageData.data[i + j];
            data[i + j] = (imgMixedVal % Math.pow(2, fac)) * Math.pow(2, 8 - fac);
        }
        data[i + 3] = 255;
    }
    return new ImageData(data, mixedImageData.width, mixedImageData.height);
}
</script>
</body>
</html>


