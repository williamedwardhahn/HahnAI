<!DOCTYPE html>
<html>
<body>
<style>
#drop-region {
	background-color: #fff;
	border-radius:20px;
	box-shadow:0 0 35px rgba(0,0,0,0.05);
	width:100%;
	padding:60px 40px;
	text-align: center;
	cursor:pointer;
	transition:.3s;
}
#drop-region:hover {
	box-shadow:0 0 45px rgba(0,0,0,0.1);
}

#image-preview, #unmixed-preview {
	margin-top:20px;
	display: flex;
	justify-content: center;
}
#image-preview .image-view, #unmixed-preview .image-view {
	display: inline-block;
	position:relative;
	margin-right: 13px;
	margin-bottom: 13px;
}
#image-preview .image-view img, #unmixed-preview .image-view img {
	width: 200px;
	height: 200px;
	object-fit: cover;
}
</style>

<div id="drop-region">
	<div class="drop-message">
		Drag & Drop image or click to upload
	</div>
	<div id="image-preview"></div>
	<div id="unmixed-preview"></div>
</div>

<script>
var dropRegion = document.getElementById("drop-region"),
	imagePreviewRegion = document.getElementById("image-preview"),
	unmixedPreviewRegion = document.getElementById("unmixed-preview");

var fakeInput = document.createElement("input");
fakeInput.type = "file";
fakeInput.accept = "image/*";
fakeInput.multiple = false;
dropRegion.addEventListener('click', function() {
	fakeInput.click();
});

fakeInput.addEventListener("change", function() {
	var files = fakeInput.files;
	handleFiles(files);
});

function preventDefault(e) {
	e.preventDefault();
  	e.stopPropagation();
}

dropRegion.addEventListener('dragenter', preventDefault, false)
dropRegion.addEventListener('dragleave', preventDefault, false)
dropRegion.addEventListener('dragover', preventDefault, false)
dropRegion.addEventListener('drop', preventDefault, false)

function handleDrop(e) {
	var dt = e.dataTransfer,
		files = dt.files;

	if (files.length) {
		handleFiles(files);
	} else {
		var html = dt.getData('text/html'),
	        match = html && /\bsrc="?([^"\s]+)"?\s*/.exec(html),
	        url = match && match[1];

	    if (url) {
	        uploadImageFromURL(url);
	        return;
	    }
	}

	function uploadImageFromURL(url) {
		var img = new Image;
        var c = document.createElement("canvas");
        var ctx = c.getContext("2d");

        img.onload = function() {
            c.width = this.naturalWidth;
            c.height = this.naturalHeight;
            ctx.drawImage(this, 0, 0);
            c.toBlob(function(blob) {
                handleFiles( [blob] );
            }, "image/png");
        };
        img.onerror = function() {
            alert("Error in uploading");
        }
        img.crossOrigin = "";
        img.src = url;
	}
}

dropRegion.addEventListener('drop', handleDrop, false);

function handleFiles(files) {
	if(files.length == 1) {
		imagePreviewRegion.innerHTML = '';
		unmixedPreviewRegion.innerHTML = '';
		if (validateImage(files[0]))
			previewAndUnmixImage(files[0]);
	}
}

function validateImage(image) {
	var validTypes = ['image/jpeg', 'image/png', 'image/gif'];
	if (validTypes.indexOf( image.type ) === -1) {
		alert("Invalid File Type");
		return false;
	}

	var maxSizeInBytes = 10e6;
	if (image.size > maxSizeInBytes) {
		alert("File too large");
		return false;
	}

	return true;
}

function previewAndUnmixImage(image) {
	var imgView = document.createElement("div");
	imgView.className = "image-view";
	imagePreviewRegion.appendChild(imgView);

	var img = document.createElement("img");
	imgView.appendChild(img);

	var reader = new FileReader();
	reader.onload = function(e) {
		img.src = e.target.result;
		showUnmixedImage(e.target.result);
	}
	reader.readAsDataURL(image);
}

var fac = 4;

function showUnmixedImage(imageSrc) {
	var canvas = document.createElement("canvas");
	var ctx = canvas.getContext("2d");

	var image = new Image();

	image.onload = function() {
		canvas.width = image.width;
		canvas.height = image.height;
		ctx.drawImage(image, 0, 0);
		var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

		var unmixedImageData = unmixImage(imageData);
		ctx.putImageData(unmixedImageData, 0, 0);
		var imgViewUnmix = document.createElement("div");
		imgViewUnmix.className = "image-view";
		unmixedPreviewRegion.appendChild(imgViewUnmix);
		var imgUnmix = document.createElement("img");
		imgViewUnmix.appendChild(imgUnmix);
		imgUnmix.src = canvas.toDataURL("image/png");
	}

	image.src = imageSrc;
}


function unmixImage(mixedImageData) {
    var data = new Uint8ClampedArray(mixedImageData.data);
    for (var i = 0; i < data.length; i += 4) {
        for (var j = 0; j < 3; j++) {
            var imgMixedVal = mixedImageData.data[i + j];
            data[i + j] = (imgMixedVal % Math.pow(2, fac)) * Math.pow(2, 8 - fac);
        }
        data[i + 3] = 255;
    }
    return new ImageData(data, mixedImageData.width, mixedImageData.height);
}

</script>
</body>
</html>


